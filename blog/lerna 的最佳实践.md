# lerna 的最佳实践 - 未完成

## 起因

笔者的需求可能和大多数人的需求不同, 出来工作之后我们的后端是一位经验很丰富的大佬, 每次
提到他的目录结构就很羡慕, 大概像下面这样.
```
.
module-1
module-2
module-3
```
每一个 module 又是一个单独的项目, 互不干扰, 用的话也很方便引入, 当时有个比较实际的
问题摆在笔者面前, 主项目是一个 Web 后台, 除此之外还有几个小项目, 微信小程序, 移动端网页,
每次开新项目都要进行一次如下的类似操作: 新增依赖, 配置 eslint 各种配置文件, 复制工具类到新项目.

### git 子模块

这类操作第一次还有新鲜感, 后面只有乏味, 并且每次改一些共有的文件每个项目都需要改, 就很麻烦,
不过当前主要改的还是工具类, 就想着如果能单独把工具类做成一个项目, 于是顺藤摸瓜查到了 `git submodule`,
git 子模块, 意思是可以在一个 git 项目中引入一个新的项目.
 
当前子模块的解决方案确实挺合适的, 只要将工具类抽出来作为一个单独的项目, 
然后在每个大项目中引入进去, 不过这个并没有成功因为当时 ide 对子模块的支持不好, 
用起来很麻烦, 并且子模块还要指定放在当前项目的某个位置, 理想情况应该是我可以像添加依赖一样在
package.json 里面添加, 在用的时候直接无需关心放在什么位置, 因为这两个原因 git submodule 
并没有使用起来.

### 初识 lerna

过了差不多小半年, 出了件大事, 因为项目是 Typescript 写的, 用了很多枚举(注意, 此处枚举和 view 层的重要程度是一样的), 
突然要根据现在的项目在衍生出一个新的项目, 并且枚举和原来的不同 (涉及到 view 层), 
这些枚举和项目的关系直观来看应该如下

```
枚举1 -> 项目1
枚举2 -> 项目2
枚举3 -> 项目3
```

而我们当前的项目只能是这样的
```
枚举1  -> 项目
```

但是实际上我们只有一个项目, 这时候要如何处理呢? 就必须要把现有的枚举和项目分离开来,
并且每种枚举一个项目, 然后才能变成下面这种结构, 但是这样也太难受了把, 分成三个项目来维护.
```
枚举1 -> 项目1
枚举2 -> 项目2
枚举3 -> 项目3
```
最后想到 Vue 作者曾经在网上说过一个叫 lerna 的库, 查了一下, 简直, "wow", 完美契合笔者一下几点需求,

 - 一个项目下面可以包含多个子项目
 - 由工具维护子项目之间的依赖关系
 - 子项目目录结构不耦合
 - 修改任意子项目之后在其他子项目中效果立竿见影
 - 共享公共配置(eslint, jest..)和通用库(ramda, rxjs...)


## lerna 是什么
`A tool for managing JavaScript projects with multiple packages.`

`管理多个 JavaScript package 的工具`

是 lerna 对自己的介绍, 下面我们将会从一个小项目开始慢慢了解 lerna,
从下面开始笔者强烈建议阅读者也跟着写一遍代码, 本文提及的代码可以在这里中找到.


### 最简单的 lerna 项目

不可避免的安装, 官方给的是直接 `npx lerna`, 这里就直接一劳永逸全局安装了.
```
npm install -g lerna # 全局安装 lerna

mkdir lerna-demo # 创建一个新项目

cd lerna-demo # 进入新项目里面

lerna init # 初始化 lerna

```

执行过如上的操作步骤之后我们可以看到项目多了两个东西

1. lerna.json
2. package.json
3. packages

先不管这些, 然后创建我们自己的库

```
mkdir packages\magic-core

mkdir packages\magic-module-a

mkdir packages\magic-module-b

```
lerna 官方也提供了一个 `lerna create` 命令, 作用就是创建的项目里面会多一些示例代码和 package.json
文件, 暂时我们不需要.

现在我们来看看当前的目录结构(如果读者是初次学习, 笔者在提醒一次, 一定要跟着敲一遍代码)
```
.
├── lerna.json
├── package.json
└── packages
    ├── magic-core
    ├── magic-module-a
    └── magic-module-b
```

### lerna.json

lerna 是一个相当优雅简介的解决方案, 我们先看看默认情况下 lerna.json 都有什么

```json
{
  "packages": [
    "packages/*"
  ],
  "version": "0.0.0"
}
```

是的, 仅仅如此, 只需要告诉 lerna 你需要被管理 `packages`, 中间不需要各种魔法(magic)操作, 
仅仅一个 lerna.json 文件和符合 lerna.json 的目录结构.



